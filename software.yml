---
- name: Ubuntu 24.04 Software Installation
  hosts: localhost
  connection: local
  become: yes
  vars:
    target_user: "{{ target_user | default(lookup('env', 'SUDO_USER') | default(ansible_user_id, true)) }}"
    target_home: "{{ '/root' if target_user == 'root' else '/home/' + target_user }}"
    php_ver: "8.4"
    node_ver: "20"
    ansible_remote_tmp: /tmp

  tasks:
    # ==================================================================
    # SECTION 1: SYSTEM DEPENDENCIES AND USER
    # ==================================================================
    - name: Install Critical System Packages
      apt:
        update_cache: yes
        name: 
          - sudo
          - acl
          - zip
          - unzip
          - git
          - curl
          - wget
          - gpg
          - supervisor
          - python3-psycopg2
          - libpq-dev
        state: present
      tags: [system]

    - name: Create User
      user:
        name: "{{ target_user }}"
        shell: /bin/bash
        groups: sudo,www-data
        append: yes
        create_home: yes
      tags: [system]

    - name: Grant Passwordless Sudo Access
      lineinfile:
        path: "/etc/sudoers.d/{{ target_user }}"
        line: "{{ target_user }} ALL=(ALL) NOPASSWD: ALL"
        create: yes
        mode: '0440'
        validate: 'visudo -cf %s'
      tags: [system]

    - name: Generate SSH Key
      user:
        name: "{{ target_user }}"
        generate_ssh_key: yes
        ssh_key_type: ed25519
        ssh_key_file: "{{ target_home }}/.ssh/id_ed25519"
      tags: [system]

    # ==================================================================
    # SECTION 2: ADD REPOSITORIES (Ubuntu 24.04 Compatible)
    # ==================================================================
    - name: Add PHP PPA
      apt_repository: { repo: "ppa:ondrej/php", state: present }
      tags: [php, nginx, database, redis]

    - name: Add PostgreSQL Repository
      shell: |
        install -d /usr/share/postgresql-common/pgdg
        curl -o /usr/share/postgresql-common/pgdg/apt.postgresql.org.asc --fail https://www.postgresql.org/media/keys/ACCC4CF8.asc
        echo "deb [signed-by=/usr/share/postgresql-common/pgdg/apt.postgresql.org.asc] https://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list
      args: { creates: /etc/apt/sources.list.d/pgdg.list }
      tags: [database]

    # ==================================================================
    # SECTION 3: INSTALL CORE SERVICES (Optimized Single Installation)
    # ==================================================================
    - name: Install PHP, Nginx, PostgreSQL, Redis (All Core Services)
      apt:
        update_cache: yes
        state: latest
        name:
          # Nginx
          - nginx
          # Redis
          - redis-server
          # PostgreSQL
          - postgresql
          - postgresql-client
          # PHP and Extensions
          - "php{{ php_ver }}"
          - "php{{ php_ver }}-fpm"
          - "php{{ php_ver }}-cli"
          - "php{{ php_ver }}-curl"
          - "php{{ php_ver }}-mbstring"
          - "php{{ php_ver }}-xml"
          - "php{{ php_ver }}-zip"
          - "php{{ php_ver }}-pgsql"
          - "php{{ php_ver }}-bcmath"
          - "php{{ php_ver }}-intl"
          - "php{{ php_ver }}-gd"
          - "php{{ php_ver }}-redis"
          - "php{{ php_ver }}-sqlite3"
          - "php{{ php_ver }}-imagick"
          - "php{{ php_ver }}-soap"
      tags: [php, nginx, database, redis]

    - name: Install Global Composer
      shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer
      args: { creates: /usr/local/bin/composer }
      tags: [php]

    - name: Enable and Start PHP-FPM
      systemd:
        name: "php{{ php_ver }}-fpm"
        enabled: yes
        state: started
      tags: [php]

    - name: Enable and Start Nginx
      systemd:
        name: nginx
        enabled: yes
        state: started
      tags: [nginx]

    - name: Enable and Start PostgreSQL
      systemd:
        name: postgresql
        enabled: yes
        state: started
      tags: [database]

    - name: Enable and Start Redis
      systemd:
        name: redis-server
        enabled: yes
        state: started
      tags: [redis]

    # ==================================================================
    # SECTION 4: NODE.JS
    # ==================================================================
    - name: Add Node.js Repository
      shell: |
        curl -fsSL https://deb.nodesource.com/setup_{{ node_ver }}.x -o /tmp/nodesource.sh && bash /tmp/nodesource.sh
      args: { creates: /etc/apt/sources.list.d/nodesource.list }
      tags: [nodejs]

    - name: Install Node.js
      apt:
        update_cache: yes
        name: nodejs
        state: latest
      tags: [nodejs]

    # ==================================================================
    # SECTION 5: DEVELOPMENT TOOLS
    # ==================================================================
    - name: Add DBeaver Repository (Ubuntu 24.04 GPG Fix)
      shell: |
        curl -fsSL https://dbeaver.io/debs/dbeaver.gpg.key | gpg --dearmor --yes -o /etc/apt/trusted.gpg.d/dbeaver.gpg
        echo "deb https://dbeaver.io/debs/dbeaver-ce /" | tee /etc/apt/sources.list.d/dbeaver.list
      args: { creates: /etc/apt/sources.list.d/dbeaver.list }
      tags: [devtools]

    - name: Add VS Code Repository (Ubuntu 24.04 GPG Fix)
      shell: |
        curl -fsSL https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor --yes -o /etc/apt/trusted.gpg.d/microsoft.gpg
        echo "deb [arch=amd64] https://packages.microsoft.com/repos/code stable main" > /etc/apt/sources.list.d/vscode.list
      args: { creates: /etc/apt/sources.list.d/vscode.list }
      tags: [devtools]

    - name: Install Development Tools
      apt:
        update_cache: yes
        name:
          - dbeaver-ce
          - code
        state: latest
      tags: [devtools]

    # ==================================================================
    # SECTION 6: GOOGLE ANTIGRAVITY EDITOR (Optional)
    # ==================================================================
    - name: Create APT Keyrings Directory for Antigravity
      file:
        path: /etc/apt/keyrings
        state: directory
        mode: '0755'
      tags: [antigravity]

    - name: Add Google Antigravity Repository Key
      shell: |
        curl -fsSL https://us-central1-apt.pkg.dev/doc/repo-signing-key.gpg | gpg --dearmor --yes -o /etc/apt/keyrings/antigravity-repo-key.gpg
      args: { creates: /etc/apt/keyrings/antigravity-repo-key.gpg }
      tags: [antigravity]

    - name: Add Google Antigravity Repository
      shell: |
        echo "deb [signed-by=/etc/apt/keyrings/antigravity-repo-key.gpg] https://us-central1-apt.pkg.dev/projects/antigravity-auto-updater-dev/ antigravity-debian main" | tee /etc/apt/sources.list.d/antigravity.list > /dev/null
      args: { creates: /etc/apt/sources.list.d/antigravity.list }
      tags: [antigravity]

    - name: Install Google Antigravity Editor
      apt:
        update_cache: yes
        name: antigravity
        state: latest
      tags: [antigravity]

    - name: ğŸ Software Installation Complete
      debug:
        msg: "All selected software has been installed successfully!"
